#!/bin/bash

# restricting access to root access
chmod 700 `which dmesg`
chmod 700 `which fuser`
chmod 700 `which kill`
chmod 700 `which killall`
chmod 700 `which pgrep`
chmod 700 `which pkill`
chmod 700 `which ps`
chmod 700 `which su`
chmod 700 `which netstat`
chmod 700 `which top`
chmod 700 `which users`
chmod 700 `which w`
chmod 700 `which wall`
chmod 700 `which who`
chmod 700 `which ss`
chmod 700 `which crontab`
chmod 700 `which ip`
chmod 700 `which mount`
chmod 700 `which umount`
chmod 700 `which passwd`
chmod 700 `which env`
chmod 700 `which openssl`
chmod 700 `which dpkg`
chmod 700 `which watch`
chmod 700 `which uname`
chmod 700 `which uptime`
chmod 700 `which last`
chmod 700 `which mesg`
chmod 700 `which lastlog`
chmod 700 `which vmstat`
chmod 700 `which readelf`
chmod 700 `which logger`
chmod 700 `which sync`
chmod 700 `which rsync`
chmod 700 `which flock`
chmod 700 `which kill`
chmod 700 `which mknod`
chmod 700 `which dd`
chmod 700 `which df`
chmod 700 `which ldd`
chmod 700 `which strip`
chmod 700 `which strace`
chmod 700 `which sleep`
chmod 700 `which yes`
chmod 700 `which xargs`
chmod 700 `which find`
# restrict access to /proc/maps/
sed -i 's/^exit 0$//' /etc/rc.local
echo -e 'mount -o remount,hidepid=2 /proc\n' >> /etc/rc.local
mount -o remount,hidepid=2 /proc
chmod 551 /proc

# tmp is not writeable
#chmod 1773 /tmp

# disable SSH
iptables -A OUTPUT -p tcp --dport 22 -j DROP
chmod 700 `which ssh`

# disable aslr
echo 'kernel.randomize_va_space = 0' > /etc/sysctl.d/01-disable-aslr.conf
sysctl -w kernel.randomize_va_space=0

declare -r SSH_PASSWORDS_FILE=/root/ssh_passwords.txt

for level in {1..5};
do
#chown .pass
levelplus=$((level+1))

#cp sources levels c 
mkdir -p /sources/level$level
#generate pass foreach level 

if [ "$levelplus" -ne 6 ]
then

#echo "level$level:` openssl rand -hex 16`" >> $SSH_PASSWORDS_FILE && 
#echo "Generating pass levels for level$level" && 
#for lines in `cut -f 2 -d ":" $SSH_PASSWORDS_FILE `; 
#do 
#	echo $lines > /home/level$level/.pass; 
#done

#not necesary, now passwords are the same per each docker run 
openssl rand -hex 6 > /home/level$level/.pass
#change level pass for bash completion 
echo "level$levelplus:level$levelplus">>/root/passlevels.txt
chpasswd < /root/passlevels.txt
echo  "level$levelplus" | chsh -s /bin/bash level$levelplus

# restore normal password 
echo "level$levelplus:`cat /home/level$level/.pass`">>/root/ssh.txt
chpasswd <  /root/ssh.txt 


#change users and setuid
echo "[+] Changing owner for file /home/level$level/level$level ..."
chown level$levelplus:level$level /home/level$level/level$level
echo "[+] Changing permissions on /home/level$level/level$level ..."
chmod 550 -R /home/level$level/level$level
echo "[+] Applying setuid on /home/level$level/level$level ..."
chmod u+s /home/level$level/level$level

echo "[+] chown && chmod .pass files /home/level$level/.pass ..." 
chown level$levelplus:level$levelplus /home/level$level/.pass
chmod u=r,g=r,o-rwx /home/level$level/.pass
#root ownser 
chown root:level$level /home/level$level/
#inmmutable 
#chattr -ia /home/level$level/level$level

echo "[+] chown && chmod /tmp ..." 
chmod -R u=rwx,og=wxt /tmp/

echo "[+] Listing passwords  level's ssh access ..." 
echo level$level `cat /home/level$level/.pass`
echo "---------------------------------------- " 

fi
done
