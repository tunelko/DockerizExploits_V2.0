#Debian 7
#FROM debian:wheezy
FROM ubuntu:trusty
# Install packages
ENV DEBIAN_FRONTEND noninteractive
RUN apt-get update && apt-get install -y openssh-server openssl apt-utils vim libc6-dev-i386 bash-completion gdb git cron
RUN mkdir /var/run/sshd
RUN echo 'root:YOUR_ROOT_PASSWORD_HERE' | chpasswd
RUN sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH login fix
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile
RUN sysctl -w kernel.randomize_va_space=0

# cool, ascii art. 
ADD motd /etc/motd

# limits nproc per level's user  
ADD limits.conf /etc/security/limits.conf 

# ADD scripts: create users, perms and get/install gdbpeda for debugging
ADD create_users.sh /create_users.sh
# first need static ssh password file to avoid regenerate foreach reboot. 
# ADD ssh_passwords.txt /root/ssh_passwords.txt
ADD generate_ssh_passwords.sh /generate_ssh_passwords.sh
ADD perms.sh /perms.sh
ADD gdbpeda.sh /gdbpeda.sh
ADD deletetmp.sh /deletetmp.sh
# give +x perms
RUN chmod 700 /*.sh

# create users 
RUN /create_users.sh 

#ADD binaries 
ADD level1 /home/level1/
ADD sources/level1.c /home/level1/

ADD level2 /home/level2/
ADD sources/level2.c /home/level2/

ADD level3 /home/level3/
ADD sources/level3.c /home/level3/


# Deprecated password generation. 
#RUN /generate_ssh_passwords.sh

# reconfigure all level permission, giving default passwords for ssh access 
RUN /perms.sh 

# gdb peda staff: install it on all users. 
RUN /gdbpeda.sh 


# change first level password and give /bin/bash 
RUN echo 'level1:level1' | chpasswd
RUN echo 'level1' | chsh -s /bin/bash level1 

# This replaces deprecated password generation on generate_passwords.sh
RUN echo 'nYjRRkCHwdAULXV6E7fFhgmw' > /home/level1/.pass
RUN echo 'bSbyvDRt2nfF7ZzEbJKUty7L' > /home/level2/.pass
RUN echo 'zZj4mDPUHwKyMfu3ZUBB5g6D' > /home/level3/.pass
RUN echo 'CjD5mNFFRhSGVJxpdqBKvnKW' > /home/level4/.pass

RUN echo 'level2:nYjRRkCHwdAULXV6E7fFhgmw' | chpasswd
RUN echo 'level3:bSbyvDRt2nfF7ZzEbJKUty7L' | chpasswd
RUN echo 'level4:zZj4mDPUHwKyMfu3ZUBB5g6D' | chpasswd
RUN echo 'level5:CjD5mNFFRhSGVJxpdqBKvnKW' | chpasswd

# go !
EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
